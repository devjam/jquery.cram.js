/* jQuery.cram.js v0.3.6 Copyright (c) Devjam / SHIFTBRAIN INC. Licensed under the MIT license. */
(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};(function(t){var n,r,i;i=window.document;n=t;r=function(){function t(r,i,s,o){this.getSpace=e(this.getSpace,this);this.searchPosOnGrid=e(this.searchPosOnGrid,this);this.setOnGrid=e(this.setOnGrid,this);this.makeGrids=e(this.makeGrids,this);this.initList=e(this.initList,this);this.updated=e(this.updated,this);this.updateEachItem=e(this.updateEachItem,this);this.getData=e(this.getData,this);this.setOptions=e(this.setOptions,this);var u;this.options=n.extend(true,null,t.defaultConfig,r);u=this.options;u.eWidth=u.cellWidth+u.marginWidth;u.eHeight=u.cellHeight+u.marginHeight;this.nowUpdate=false;if(i!=null&&s!=null&&o!=null){this.getData(i,s,o)}}t.defaultConfig={itemSelector:"*",cellWidth:100,cellHeight:10,marginWidth:20,marginHeight:20,isWindowResizeUpdate:true,isAutoLayout:true,isDrawSpace:false,animation:{delayEach:0,duration:0,ease:null}};t.prototype.setOptions=function(e){var t;this.options=n.extend(true,this.options,e);t=this.options;t.eWidth=t.cellWidth+t.marginWidth;return t.eHeight=t.cellHeight+t.marginHeight};t.prototype.getData=function(e,t,n){var r,i,s;if(e!=null&&t!=null&&n!=null){this.callback=n;if(this.nowUpdate&&this.list!=null){this.updated();return}s=this.options;this.nowUpdate=true;this.max_offx=0;this.max_offy=0;this.startRow=0;this.itemNum=0;this.list_temp=[];this.map=[];this.list_temp=this.initList(t);r=(e+s.marginWidth)/s.eWidth<<0;i=Math.ceil(this.itemWidthMax/s.eWidth);this.cols=Math.max(r,i);this.map=this.makeGrids();return this.tempTimer=setTimeout(this.updateEachItem,0)}};t.prototype.updateEachItem=function(){var e;clearTimeout(this.tempTimer);if(this.itemNum<this.list_temp.length){e=this.list_temp[this.itemNum];if(e.x!=null&&e.y!=null){this.map=this.setOnGrid(this.map,e)}else{this.map=this.searchPosOnGrid(this.map,e)}this.itemNum++;return this.tempTimer=setTimeout(this.updateEachItem,0)}else{this.list=this.list_temp;return this.tempTimer=setTimeout(this.updated,0)}};t.prototype.updated=function(){var e,t,n;clearTimeout(this.tempTimer);n=this.options;e=this.cols*n.eWidth-n.marginWidth;t={};t.area={width:e,height:this.areaHeight};t.items=this.list;if(n.isDrawSpace){t.spaces=this.getSpace(this.map.slice(0,this.max_offy+1))}this.nowUpdate=false;return this.callback(t)};t.prototype.initList=function(e){var t,r,i,s,o,u,a,f,l,c;this.itemWidthMax=0;l=this.options;o=e.length;if(o<=0){return[]}u=[];a=[];f=[];i=false;if(e[0].element!=null||e[0].width!=null){i=true}r=0;while(r<o){if(i){s=e[r]}else{s={};s.element=e[r]}if(s.width==null){s.width=n(s.element).outerWidth()}if(s.height==null){s.height=n(s.element).outerHeight()}c=s.width+l.marginWidth;t=s.height+l.marginHeight;if(this.itemWidthMax<c){this.itemWidthMax=c}s.cols=Math.ceil(c/l.eWidth);s.rows=Math.ceil(t/l.cellHeight);if(s.x!=null&&s.y!=null){a.push(s)}else{f.push(s)}r++}return u=a.concat(f)};t.prototype.makeGrids=function(){var e,t,n,r,i,s,o;this.areaHeight=0;s=[];e=this.cols;r=this.list_temp.length;t=0;o=1;while(t<r){o+=this.list_temp[t].rows;t++}r=o;t=0;while(t<r){i=[];n=0;while(n<e){i.push(0);n++}s.push(i);t++}return s};t.prototype.setOnGrid=function(e,t){var n,r,i,s,o,u,a,f;i=this.options;s=t.x/i.eWidth<<0;o=t.y/i.cellHeight<<0;a=e.length-o;if(a>t.rows){a=t.rows}r=e[0].length-s;if(r>t.cols){r=t.cols}t.rectWidth=t.cols*i.eWidth-i.marginWidth;t.rectHeight=t.rows*i.cellHeight-i.marginHeight;f=o*i.cellHeight+i.cellHeight*t.rows;if(f>this.areaHeight){this.areaHeight=f}u=0;while(u<a){n=0;while(n<r){e[o+u][s+n]=1;n++}u++}return e};t.prototype.searchPosOnGrid=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v;l=this.options;a=e[0].length-t.cols+1;f=e.length;c=0;h=0;u=f;s=this.startRow;while(s<u){n=e[s].join();if(n.indexOf("0")>-1){s+=u}else{this.startRow++}s++}u=f-t.rows;s=this.startRow;while(s<u){o=0;while(o<a){if(e[s][o]===0){d=t.rows;i=t.cols;p=s+d-1;r=o+i-1;if(e[p][r]===0){v=0;p=0;r=0;while(r<i){v+=e[s+p][o+r];r++}if(v===0){p++;while(p<d){r=0;while(r<i){v+=e[s+p][o+r];r++}p++}if(v===0){c=o;h=s;if(h>this.max_offy||c>this.max_offx&&h>=this.max_offy){this.max_offx=c;this.max_offy=h}o+=a;s+=f}}}}o++}s++}t.x=c*l.eWidth;t.y=h*l.cellHeight;return e=this.setOnGrid(e,t)};t.prototype.getSpace=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;u=this.options;t=[];o=[];if(e.length<1){return t}n=e[0].length;f=e.length;i=0;while(i<n){s=f-1;while(s>=0){d=e[s][i];if(d>0){s=-1}else{e[s][i]=1;s--}}i++}r=true;while(r&&e.length>0){d=e[e.length-1].join("");if(d.indexOf("0")!==-1){r=false}else{e.pop()}}f=e.length;i=0;while(i<f){s=0;while(s<n){if(e[i][s]===0){d=this.getSpaceRectSize(e,s,i);a={x:s*u.eWidth,y:i*u.cellHeight,cols:d.cols,rows:d.rows,width:d.cols*u.eWidth-u.marginWidth,height:d.rows*u.cellHeight-u.marginHeight};if(a.width>0&&a.height>0){t.push(a)}p=s+d.cols;c=i+d.rows;l=i;while(l<c){h=s;while(h<p){e[l][h]=1;h++}l++}}s++}i++}return t};t.prototype.getSpaceRectSize=function(e,t,n){var r,i,s,o,u,a,f;f=1;i=1;s=t+1;o=e[0].length;while(s<o){if(e[n][s]>0){s+=o}else{f++;s++}}o=f;r=true;while(r){i++;s=0;while(s<o){u=t+s;a=n+i;if(a>=e.length){r=false;s+=o}else{if(e[a][u]>0){r=false;s+=o}else{s++}}}}return{cols:f,rows:i}};return t}();n.fn.cram=function(e){var t;t=n.extend(true,null,r.defaultConfig,e);this.each(function(){var e,i,s,o,u,a,f,l,c=this;n.fn.cram.setOptions=function(e){t=n.extend(true,t,e);return null};n.fn.cram.update=function(){var e,i;clearTimeout(c.tempTimer);c.nowUpdate=true;i=n(c).parent().width();e=n(c).children(t.itemSelector);return c.cr=new r(t,i,e,f)};n.fn.cram.getData=function(){return n.data(c,"cram")};a=function(){if(!t.isWindowResizeUpdate||c.nowUpdate){return}if(c.resizeTimer!=null){clearTimeout(c.resizeTimer)}return c.resizeTimer=setTimeout(u,200)};u=function(){var e,r;if(c.resizeTimer!=null){clearTimeout(c.resizeTimer)}r=t;e=n(c).parent().width()/r.eWidth<<0;n(c).children(r.itemSelector).each(function(t,i){var s;s=Math.ceil(n(i).outerWidth()/r.eWidth);if(s>e){return e=s}});if(e===c.cols){return}c.cols=e;return c.tempTimer=setTimeout(n(c).cram.update,0)};f=function(r){var o,u;o=t;n(".space").remove();u=n.data(c,"cram");u.items=r.items;u.spaces=r.spaces;u.area=r.area;c.tempTimer=setTimeout(function(){clearTimeout(c.tempTimer);if(o.isAutoLayout){i(r.items,r.area.width);if(o.isDrawSpace){s(r.spaces)}return e(r.area.width,r.area.height)}else{return l()}},0);return c.cr=null};l=function(){n(c).trigger("cram.update");return c.tempTimer=setTimeout(function(){clearTimeout(c.tempTimer);return c.nowUpdate=false},1)};i=function(e,r){var i,s,o,u,a,f,l,c;l=t;i=l.animation;s=r/l.eWidth<<0;f=e.length;u=0;while(u<f){a=e[u];c={top:a.y+"px",left:a.x+"px"};o=i.delayEach*(s*a.rows+a.cols);n(a.element).stop().queue([]);if(o>0){if(i.duration>0){n(a.element).delay(o).animate(c,i.duration,i.ease)}else{n(a.element).delay(o).css(c)}}else{if(i.duration>0){n(a.element).animate(c,i.duration,i.ease)}else{n(a.element).css(c)}}u++}return null};s=function(e){var r,i,s,o,u;r=t.animation;o=e.length;i=0;while(i<o){s=e[i];n(c).append('<li class="space"></li>');u={top:s.y+"px",left:s.x+"px",width:s.width+"px",height:s.height+"px"};n(".space:last").css(u);i++;if(r.duration>0){n(".space").css("display","none");n(".space").delay(r.duration*.8).fadeIn(r.duration*.8,r.ease)}}return null};e=function(e,r){var i,s;i=t.animation;n(c).stop().queue([]);s={width:e+"px",height:r+"px"};if(i.duration>0){n(c).animate(s,i.duration,i.ease,l)}else{n(c).css(s);l()}return null};n.data(this,"cram",{});this.list=[];o=t;o.eWidth=o.cellWidth+o.marginWidth;o.eHeight=o.cellHeight+o.marginHeight;this.cols=0;this.resizeTimer=null;this.nowUpdate=false;return n(window).bind("resize",a)});return this};return this.cram=r})(jQuery)}).call(this);